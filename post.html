<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章详情 - LZM博客</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="index.html">LZM博客</a>
        </div>
        <div class="nav-links">
            <a href="index.html">首页</a>
            <a href="admin.html" id="admin-link">管理</a>
        </div>
    </nav>

    <div class="container">
        <article id="post-content" class="post-detail"></article>
        
        <div class="comments-section">
            <h3>评论</h3>
            
            <div class="comment-form">
                <h4>发表评论</h4>
                <form id="comment-form">
                    <div class="form-group">
                        <input type="text" id="author-name" placeholder="您的姓名" required>
                    </div>
                    <div class="form-group">
                        <textarea id="comment-content" placeholder="写下您的评论..." required></textarea>
                    </div>
                    <button type="submit" class="btn">提交评论</button>
                </form>
            </div>
            
            <div id="comments-list" class="comments-list"></div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 LZM博客. 保留所有权利.</p>
    </footer>

    <script src="blog.js"></script>
    <script>
        // 文章详情页特定功能
        const postId = new URLSearchParams(window.location.search).get('id');
        
        // 渲染Markdown内容
        function renderMarkdown(content) {
            return marked.parse(content);
        }
        
        // 加载文章详情
        async function loadPostDetail() {
            if (!postId) {
                window.location.href = 'index.html';
                return;
            }
            
            const { data: post, error } = await supabase
                .from('posts')
                .select('*')
                .eq('id', postId)
                .eq('status', 'published')
                .single();
                
            if (error || !post) {
                document.getElementById('post-content').innerHTML = '<p>文章不存在</p>';
                return;
            }
            
            // 更新浏览量
            await supabase
                .from('posts')
                .update({ view_count: (post.view_count || 0) + 1 })
                .eq('id', postId);
            
            // 渲染文章内容
            const postDate = new Date(post.published_at || post.created_at).toLocaleDateString('zh-CN');
            document.getElementById('post-content').innerHTML = `
                <header class="post-header">
                    <h1>${post.title}</h1>
                    <div class="post-meta">
                        <span>发布于: ${postDate}</span>
                        <span>浏览: ${post.view_count || 0}次</span>
                    </div>
                </header>
                <div class="post-body">${renderMarkdown(post.content)}</div>
            `;
            
            // 高亮代码块
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // 设置页面标题
            document.title = `${post.title} - LZM博客`;
        }
        
        // 加载评论
        async function loadComments() {
            const { data: comments, error } = await supabase
                .from('comments')
                .select('*')
                .eq('post_id', postId)
                .order('created_at', { ascending: false });
                
            if (error) {
                console.error('加载评论失败:', error);
                return;
            }
            
            const commentsList = document.getElementById('comments-list');
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p>暂无评论</p>';
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => `
                <div class="comment">
                    <div class="comment-header">
                        <strong>${comment.author_name}</strong>
                        <span>${new Date(comment.created_at).toLocaleString('zh-CN')}</span>
                        ${comment.location ? `<span>来自: ${comment.location}</span>` : ''}
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-actions">
                        <button class="like-btn" data-comment-id="${comment.id}">
                            👍 <span class="like-count">${comment.like_count || 0}</span>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // 添加点赞事件监听
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const commentId = btn.dataset.commentId;
                    await likeComment(commentId);
                });
            });
        }
        
        // 点赞评论
        async function likeComment(commentId) {
            // 获取用户IP作为唯一标识
            const userIp = await getUserIP();
            
            // 检查是否已经点赞
            const { data: existingLike, error: checkError } = await supabase
                .from('comment_likes')
                .select('id')
                .eq('comment_id', commentId)
                .eq('user_ip', userIp)
                .single();
                
            if (existingLike) {
                alert('您已经点过赞了');
                return;
            }
            
            // 添加点赞记录
            const { error: likeError } = await supabase
                .from('comment_likes')
                .insert([{ comment_id: commentId, user_ip: userIp }]);
                
            if (likeError) {
                console.error('点赞失败:', likeError);
                return;
            }
            
            // 更新评论点赞数
            const { error: updateError } = await supabase.rpc('increment_comment_likes', {
                comment_id: commentId
            });
            
            if (updateError) {
                console.error('更新点赞数失败:', updateError);
                return;
            }
            
            // 更新UI
            const likeCountEl = document.querySelector(`.like-btn[data-comment-id="${commentId}"] .like-count`);
            if (likeCountEl) {
                likeCountEl.textContent = parseInt(likeCountEl.textContent) + 1;
            }
            
            alert('点赞成功!');
        }
        
        // 获取用户IP
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                // 如果获取IP失败，使用随机标识
                return `anonymous_${Math.random().toString(36).substr(2, 9)}`;
            }
        }
        
        // 提交评论
        document.getElementById('comment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const authorName = document.getElementById('author-name').value;
            const content = document.getElementById('comment-content').value;
            
            if (!authorName || !content) {
                alert('请填写姓名和评论内容');
                return;
            }
            
            // 获取用户大致位置
            let location = '';
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                location = `${data.city}, ${data.country_name}`;
            } catch (error) {
                console.error('获取位置信息失败:', error);
            }
            
            // 提交评论
            const { error } = await supabase
                .from('comments')
                .insert([{
                    post_id: postId,
                    author_name: authorName,
                    content: content,
                    location: location
                }]);
                
            if (error) {
                console.error('提交评论失败:', error);
                alert('评论提交失败，请重试');
                return;
            }
            
            // 清空表单
            document.getElementById('author-name').value = '';
            document.getElementById('comment-content').value = '';
            
            // 重新加载评论
            loadComments();
            
            alert('评论提交成功!');
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadPostDetail();
            loadComments();
        });
    </script>
</body>
</html>
