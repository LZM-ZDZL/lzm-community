<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - LZMåšå®¢</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="index.html">LZMåšå®¢</a>
        </div>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="admin.html" id="admin-link">ç®¡ç†</a>
        </div>
    </nav>

    <div class="container">
        <article id="post-content" class="post-detail"></article>
        
        <div class="comments-section">
            <h3>è¯„è®º</h3>
            
            <div class="comment-form">
                <h4>å‘è¡¨è¯„è®º</h4>
                <form id="comment-form">
                    <div class="form-group">
                        <input type="text" id="author-name" placeholder="æ‚¨çš„å§“å" required>
                    </div>
                    <div class="form-group">
                        <textarea id="comment-content" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." required></textarea>
                    </div>
                    <button type="submit" class="btn">æäº¤è¯„è®º</button>
                </form>
            </div>
            
            <div id="comments-list" class="comments-list"></div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 LZMåšå®¢. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
    </footer>

    <script src="blog.js"></script>
    <script>
        // æ–‡ç« è¯¦æƒ…é¡µç‰¹å®šåŠŸèƒ½
        const postId = new URLSearchParams(window.location.search).get('id');
        
        // æ¸²æŸ“Markdownå†…å®¹
        function renderMarkdown(content) {
            return marked.parse(content);
        }
        
        // åŠ è½½æ–‡ç« è¯¦æƒ…
        async function loadPostDetail() {
            if (!postId) {
                window.location.href = 'index.html';
                return;
            }
            
            const { data: post, error } = await supabase
                .from('posts')
                .select('*')
                .eq('id', postId)
                .eq('status', 'published')
                .single();
                
            if (error || !post) {
                document.getElementById('post-content').innerHTML = '<p>æ–‡ç« ä¸å­˜åœ¨</p>';
                return;
            }
            
            // æ›´æ–°æµè§ˆé‡
            await supabase
                .from('posts')
                .update({ view_count: (post.view_count || 0) + 1 })
                .eq('id', postId);
            
            // æ¸²æŸ“æ–‡ç« å†…å®¹
            const postDate = new Date(post.published_at || post.created_at).toLocaleDateString('zh-CN');
            document.getElementById('post-content').innerHTML = `
                <header class="post-header">
                    <h1>${post.title}</h1>
                    <div class="post-meta">
                        <span>å‘å¸ƒäº: ${postDate}</span>
                        <span>æµè§ˆ: ${post.view_count || 0}æ¬¡</span>
                    </div>
                </header>
                <div class="post-body">${renderMarkdown(post.content)}</div>
            `;
            
            // é«˜äº®ä»£ç å—
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // è®¾ç½®é¡µé¢æ ‡é¢˜
            document.title = `${post.title} - LZMåšå®¢`;
        }
        
        // åŠ è½½è¯„è®º
        async function loadComments() {
            const { data: comments, error } = await supabase
                .from('comments')
                .select('*')
                .eq('post_id', postId)
                .order('created_at', { ascending: false });
                
            if (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                return;
            }
            
            const commentsList = document.getElementById('comments-list');
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p>æš‚æ— è¯„è®º</p>';
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => `
                <div class="comment">
                    <div class="comment-header">
                        <strong>${comment.author_name}</strong>
                        <span>${new Date(comment.created_at).toLocaleString('zh-CN')}</span>
                        ${comment.location ? `<span>æ¥è‡ª: ${comment.location}</span>` : ''}
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-actions">
                        <button class="like-btn" data-comment-id="${comment.id}">
                            ğŸ‘ <span class="like-count">${comment.like_count || 0}</span>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // æ·»åŠ ç‚¹èµäº‹ä»¶ç›‘å¬
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const commentId = btn.dataset.commentId;
                    await likeComment(commentId);
                });
            });
        }
        
        // ç‚¹èµè¯„è®º
        async function likeComment(commentId) {
            // è·å–ç”¨æˆ·IPä½œä¸ºå”¯ä¸€æ ‡è¯†
            const userIp = await getUserIP();
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç‚¹èµ
            const { data: existingLike, error: checkError } = await supabase
                .from('comment_likes')
                .select('id')
                .eq('comment_id', commentId)
                .eq('user_ip', userIp)
                .single();
                
            if (existingLike) {
                alert('æ‚¨å·²ç»ç‚¹è¿‡èµäº†');
                return;
            }
            
            // æ·»åŠ ç‚¹èµè®°å½•
            const { error: likeError } = await supabase
                .from('comment_likes')
                .insert([{ comment_id: commentId, user_ip: userIp }]);
                
            if (likeError) {
                console.error('ç‚¹èµå¤±è´¥:', likeError);
                return;
            }
            
            // æ›´æ–°è¯„è®ºç‚¹èµæ•°
            const { error: updateError } = await supabase.rpc('increment_comment_likes', {
                comment_id: commentId
            });
            
            if (updateError) {
                console.error('æ›´æ–°ç‚¹èµæ•°å¤±è´¥:', updateError);
                return;
            }
            
            // æ›´æ–°UI
            const likeCountEl = document.querySelector(`.like-btn[data-comment-id="${commentId}"] .like-count`);
            if (likeCountEl) {
                likeCountEl.textContent = parseInt(likeCountEl.textContent) + 1;
            }
            
            alert('ç‚¹èµæˆåŠŸ!');
        }
        
        // è·å–ç”¨æˆ·IP
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                // å¦‚æœè·å–IPå¤±è´¥ï¼Œä½¿ç”¨éšæœºæ ‡è¯†
                return `anonymous_${Math.random().toString(36).substr(2, 9)}`;
            }
        }
        
        // æäº¤è¯„è®º
        document.getElementById('comment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const authorName = document.getElementById('author-name').value;
            const content = document.getElementById('comment-content').value;
            
            if (!authorName || !content) {
                alert('è¯·å¡«å†™å§“åå’Œè¯„è®ºå†…å®¹');
                return;
            }
            
            // è·å–ç”¨æˆ·å¤§è‡´ä½ç½®
            let location = '';
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                location = `${data.city}, ${data.country_name}`;
            } catch (error) {
                console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
            }
            
            // æäº¤è¯„è®º
            const { error } = await supabase
                .from('comments')
                .insert([{
                    post_id: postId,
                    author_name: authorName,
                    content: content,
                    location: location
                }]);
                
            if (error) {
                console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
                alert('è¯„è®ºæäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                return;
            }
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('author-name').value = '';
            document.getElementById('comment-content').value = '';
            
            // é‡æ–°åŠ è½½è¯„è®º
            loadComments();
            
            alert('è¯„è®ºæäº¤æˆåŠŸ!');
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadPostDetail();
            loadComments();
        });
    </script>
</body>
</html>
